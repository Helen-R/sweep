<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to sweep • sweep</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google analytics --><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-76139189-1', 'auto');
  ga('send', 'pageview');

</script>
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">sweep</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/SW00_Introduction_to_sweep.html">Introduction to sweep</a>
    </li>
    <li>
      <a href="../articles/SW01_Forecasting_Time_Series_Groups.html">Forecasting time series groups</a>
    </li>
    <li>
      <a href="../articles/SW02_Forecasting_Multiple_Models.html">Forecasting multiple models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/business-science/sweep">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Introduction to sweep</h1>
                        <h4 class="author">Matt Dancho</h4>
            
            <h4 class="date">2017-10-23</h4>
          </div>

    
    
<div class="contents">
<blockquote>
<p>Extending <code>broom</code> to time series forecasting</p>
</blockquote>
<p>The <code>sweep</code> package extends the <code>broom</code> tools (tidy, glance, and augment) for performing forecasts and time series analysis in the “tidyverse”. The package is geared towards the workflow required to perform forecasts using Rob Hyndman’s <code>forecast</code> package, and contains the following elements:</p>
<ol style="list-style-type: decimal">
<li><p><strong>model tidiers</strong>: <code>sw_tidy</code>, <code>sw_glance</code>, <code>sw_augment</code>, <code>sw_tidy_decomp</code> functions extend <code>tidy</code>, <code>glance</code>, and <code>augment</code> from the <code>broom</code> package specifically for models (<code><a href="http://www.rdocumentation.org/packages/forecast/topics/ets">ets()</a></code>, <code><a href="http://www.rdocumentation.org/packages/forecast/topics/Arima">Arima()</a></code>, <code><a href="http://www.rdocumentation.org/packages/forecast/topics/bats">bats()</a></code>, etc) used for forecasting.</p></li>
<li><p><strong>forecast tidier</strong>: <code>sw_sweep</code> converts a <code>forecast</code> object to a tibble that can be easily manipulated in the “tidyverse”.</p></li>
</ol>
<p>To illustrate, let’s take a basic forecasting workflow starting from data collected in a tibble format and then performing a forecast to achieve the end result in tibble format.</p>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Before we get started, load the following packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(forecast)
<span class="kw">library</span>(tidyquant)
<span class="kw">library</span>(timetk)
<span class="kw">library</span>(sweep)</code></pre></div>
</div>
<div id="forecasting-sales-of-beer-wine-and-distilled-alcohol-beverages" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting-sales-of-beer-wine-and-distilled-alcohol-beverages" class="anchor"></a>Forecasting Sales of Beer, Wine, and Distilled Alcohol Beverages</h1>
<p>We’ll use the <code>tidyquant</code> package to get the US alcohol sales, which comes from the FRED data base (the origin is the US Bureau of the Census, one of the 80+ data sources FRED connects to). The FRED code is “S4248SM144NCEN” and the data set can be found <a href="https://fred.stlouisfed.org/series/S4248SM144NCEN">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alcohol_sales_tbl &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/tq_get">tq_get</a></span>(<span class="st">"S4248SM144NCEN"</span>, 
                            <span class="dt">get  =</span> <span class="st">"economic.data"</span>, 
                            <span class="dt">from =</span> <span class="st">"2007-01-01"</span>,
                            <span class="dt">to   =</span> <span class="st">"2016-12-31"</span>)
alcohol_sales_tbl</code></pre></div>
<pre><code>## # A tibble: 120 x 2
##          date price
##        &lt;date&gt; &lt;int&gt;
##  1 2007-01-01  6627
##  2 2007-02-01  6743
##  3 2007-03-01  8195
##  4 2007-04-01  7828
##  5 2007-05-01  9570
##  6 2007-06-01  9484
##  7 2007-07-01  8608
##  8 2007-08-01  9543
##  9 2007-09-01  8123
## 10 2007-10-01  9649
## # ... with 110 more rows</code></pre>
<p>We can quickly visualize using the <code>ggplot2</code> package. We can see that there appears to be some seasonality and an upward trend.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alcohol_sales_tbl <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> price)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"US Alcohol Sales: Monthly"</span>, <span class="dt">x =</span> <span class="st">""</span>, <span class="dt">y =</span> <span class="st">"Millions"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">date_breaks =</span> <span class="st">"1 year"</span>, <span class="dt">date_labels =</span> <span class="st">"%Y"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>()</code></pre></div>
<p><img src="SW00_Introduction_to_sweep_files/figure-html/unnamed-chunk-4-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="forecasting-workflow" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting-workflow" class="anchor"></a>Forecasting Workflow</h1>
<p>The forecasting workflow involves a few basic steps:</p>
<ol style="list-style-type: decimal">
<li>Step 1: Coerce to a <code>ts</code> object class.</li>
<li>Step 2: Apply a model (or set of models)</li>
<li>Step 3: Forecast the models (similar to predict)</li>
<li>Step 4: Use <code><a href="../reference/sw_sweep.html">sw_sweep()</a></code> to tidy the forecast.</li>
</ol>
<p><em>Note that we purposely omit other steps such as testing the series for stationarity (<code>Box.test(type = "Ljung")</code>) and analysis of autocorrelations (<code>Acf</code>, <code>Pacf</code>) for brevity purposes. We recommend the analyst to follow the forecasting workflow in <a href="https://www.otexts.org/book/fpp">“Forecasting: principles and practice”</a></em></p>
<div id="step-1-coerce-to-a-ts-object-class" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1-coerce-to-a-ts-object-class" class="anchor"></a>Step 1: Coerce to a <code>ts</code> object class</h2>
<p>The <code>forecast</code> package uses the <code>ts</code> data structure, which is quite a bit different than tibbles that we are currently using. Fortunately, it’s easy to get to the correct structure with <code><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_ts">tk_ts()</a></code> from the <code>timetk</code> package. The <code>start</code> and <code>freq</code> variables are required for the regularized time series (<code>ts</code>) class, and these specify how to treat the time series. For monthly, the frequency should be specified as 12. This results in a nice calendar view. The <code>silent = TRUE</code> tells the <code><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_ts">tk_ts()</a></code> function to skip the warning notifying us that the “date” column is being dropped. Non-numeric columns must be dropped for <code>ts</code> class, which is matrix based and a homogeneous data class.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">alcohol_sales_ts &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_ts">tk_ts</a></span>(alcohol_sales_tbl, <span class="dt">start =</span> <span class="dv">2007</span>, <span class="dt">freq =</span> <span class="dv">12</span>, <span class="dt">silent =</span> <span class="ot">TRUE</span>)
alcohol_sales_ts</code></pre></div>
<pre><code>##        Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct   Nov
## 2007  6627  6743  8195  7828  9570  9484  8608  9543  8123  9649  9390
## 2008  7093  7483  8365  8895  9794  9977  9553  9375  9225  9948  8758
## 2009  7266  7578  8688  9162  9369 10167  9507  8923  9272  9075  8949
## 2010  6558  7481  9475  9424  9351 10552  9077  9273  9420  9413  9866
## 2011  6901  8014  9833  9281  9967 11344  9106 10468 10085  9612 10328
## 2012  7486  8641  9709  9423 11342 11274  9845 11163  9532 10754 10953
## 2013  8395  8888 10109 10493 12217 11385 11186 11462 10494 11541 11139
## 2014  8559  9061 10058 10979 11794 11906 10966 10981 10827 11815 10466
## 2015  8398  9061 10720 11105 11505 12903 11866 11223 12023 11986 11510
## 2016  8540 10158 11879 11155 11916 13291 10540 12212 11786 11424 12482
##        Dec
## 2007 10065
## 2008 10839
## 2009 10843
## 2010 11455
## 2011 11483
## 2012 11922
## 2013 12709
## 2014 13303
## 2015 14190
## 2016 13832</code></pre>
<p>A significant benefit is that the resulting <code>ts</code> object maintains a “timetk index”, which will help with forecasting dates later. We can verify this using <code><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_index">has_timetk_idx()</a></code> from the <code>timetk</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_index">has_timetk_idx</a></span>(alcohol_sales_ts)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<p>Now that a time series has been coerced, let’s proceed with modeling.</p>
</div>
<div id="step-2-modeling-a-time-series" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2-modeling-a-time-series" class="anchor"></a>Step 2: Modeling a time series</h2>
<p>The modeling workflow takes a time series object and applies a model. Nothing new here: we’ll simply use the <code><a href="http://www.rdocumentation.org/packages/forecast/topics/ets">ets()</a></code> function from the <code>forecast</code> package to get an Exponential Smoothing ETS (Error, Trend, Seasonal) model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fit_ets &lt;-<span class="st"> </span>alcohol_sales_ts <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/forecast/topics/ets">ets</a></span>()</code></pre></div>
<p>Where <code>sweep</code> can help is in the evaluation of a model. Expanding on the <code>broom</code> package there are four functions:</p>
<ul>
<li>
<code><a href="../reference/sw_tidy.html">sw_tidy()</a></code>: Returns a tibble of model parameters</li>
<li>
<code><a href="../reference/sw_glance.html">sw_glance()</a></code>: Returns the model accuracy measurements</li>
<li>
<code><a href="../reference/sw_augment.html">sw_augment()</a></code>: Returns the fitted and residuals of the model</li>
<li>
<code><a href="../reference/sw_tidy_decomp.html">sw_tidy_decomp()</a></code>: Returns a tidy decomposition from a model</li>
</ul>
<p>The guide below shows which model object compatibility with <code>sweep</code> tidier functions.</p>
<table class="table">
<caption>Function Compatibility</caption>
<thead><tr class="header">
<th align="left">Object</th>
<th align="center">sw_tidy()</th>
<th align="center">sw_glance()</th>
<th align="center">sw_augment()</th>
<th align="center">sw_tidy_decomp()</th>
<th align="center">sw_sweep()</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">ar</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">arima</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">Arima</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">ets</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">baggedETS</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">bats</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">tbats</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">nnetar</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">stl</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">HoltWinters</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">StructTS</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">tslm</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">decompose</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">X</td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">adf.test</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">Box.test</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="even">
<td align="left">kpss.test</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr class="odd">
<td align="left">forecast</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">X</td>
</tr>
</tbody>
</table>
<p>Going through the tidiers, we can get useful <code>model</code> information.</p>
<div id="sw_tidy" class="section level3">
<h3 class="hasAnchor">
<a href="#sw_tidy" class="anchor"></a>sw_tidy</h3>
<p><code><a href="../reference/sw_tidy.html">sw_tidy()</a></code> returns the model parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_tidy.html">sw_tidy</a></span>(fit_ets)</code></pre></div>
<pre><code>## # A tibble: 16 x 2
##     term     estimate
##    &lt;chr&gt;        &lt;dbl&gt;
##  1 alpha 1.012213e-01
##  2  beta 2.016581e-03
##  3 gamma 1.018853e-04
##  4     l 8.570668e+03
##  5     b 3.891214e+01
##  6    s0 1.184386e+00
##  7    s1 1.017722e+00
##  8    s2 1.037018e+00
##  9    s3 9.902850e-01
## 10    s4 1.037780e+00
## 11    s5 1.000532e+00
## 12    s6 1.112764e+00
## 13    s7 1.067384e+00
## 14    s8 9.811133e-01
## 15    s9 9.701571e-01
## 16   s10 8.332680e-01</code></pre>
</div>
<div id="sw_glance" class="section level3">
<h3 class="hasAnchor">
<a href="#sw_glance" class="anchor"></a>sw_glance</h3>
<p><code><a href="../reference/sw_glance.html">sw_glance()</a></code> returns the model quality parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_glance.html">sw_glance</a></span>(fit_ets)</code></pre></div>
<pre><code>## # A tibble: 1 x 12
##   model.desc      sigma    logLik     AIC      BIC        ME     RMSE
##        &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1 ETS(M,A,M) 0.04227481 -1012.805 2059.61 2106.997 -40.84778 427.9228
## # ... with 5 more variables: MAE &lt;dbl&gt;, MPE &lt;dbl&gt;, MAPE &lt;dbl&gt;, MASE &lt;dbl&gt;,
## #   ACF1 &lt;dbl&gt;</code></pre>
</div>
<div id="sw_augment" class="section level3">
<h3 class="hasAnchor">
<a href="#sw_augment" class="anchor"></a>sw_augment</h3>
<p><code><a href="../reference/sw_augment.html">sw_augment()</a></code> returns the actual, fitted and residual values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">augment_fit_ets &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sw_augment.html">sw_augment</a></span>(fit_ets)
augment_fit_ets</code></pre></div>
<pre><code>## # A tibble: 120 x 4
##            index .actual  .fitted       .resid
##    &lt;S3: yearmon&gt;   &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt;
##  1      Jan 2007    6627 6608.634  0.002779153
##  2      Feb 2007    6743 7208.570 -0.064585640
##  3      Mar 2007    8195 8374.630 -0.021449283
##  4      Apr 2007    7828 8487.572 -0.077710309
##  5      May 2007    9570 9199.798  0.040240284
##  6      Jun 2007    9484 9670.953 -0.019331429
##  7      Jul 2007    8608 8715.021 -0.012280119
##  8      Aug 2007    9543 9065.848  0.052631819
##  9      Sep 2007    8123 8733.843 -0.069939764
## 10      Oct 2007    9649 9118.519  0.058176260
## # ... with 110 more rows</code></pre>
<p>We can review the residuals to determine if their are any underlying patterns left. Note that the index is class <code>yearmon</code>, which is a regularized date format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">augment_fit_ets <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> index, <span class="dt">y =</span> .resid)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">"grey40"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_yearmon</span>(<span class="dt">n =</span> <span class="dv">10</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"US Alcohol Sales: ETS Residuals"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>()</code></pre></div>
<p><img src="SW00_Introduction_to_sweep_files/figure-html/unnamed-chunk-12-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="sw_tidy_decomp" class="section level3">
<h3 class="hasAnchor">
<a href="#sw_tidy_decomp" class="anchor"></a>sw_tidy_decomp</h3>
<p><code><a href="../reference/sw_tidy_decomp.html">sw_tidy_decomp()</a></code> returns the decomposition of the ETS model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">decomp_fit_ets &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sw_tidy_decomp.html">sw_tidy_decomp</a></span>(fit_ets)
decomp_fit_ets </code></pre></div>
<pre><code>## # A tibble: 121 x 5
##            index observed    level    slope    season
##    &lt;S3: yearmon&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
##  1      Dec 2006       NA 8570.668 38.91214 1.1843861
##  2      Jan 2007     6627 8612.002 38.96039 0.7675909
##  3      Feb 2007     6743 8594.407 37.83367 0.8332625
##  4      Mar 2007     8195 8613.499 37.46029 0.9701550
##  5      Apr 2007     7828 8582.912 36.10461 0.9811056
##  6      May 2007     9570 8654.123 36.80402 1.0673881
##  7      Jun 2007     9484 8673.921 36.46522 1.1127621
##  8      Jul 2007     8608 8699.559 36.24952 1.0005309
##  9      Aug 2007     9543 8782.348 37.17671 1.0377856
## 10      Sep 2007     8123 8757.088 35.93281 0.9902779
## # ... with 111 more rows</code></pre>
<p>We can review the decomposition using <code>ggplot2</code> as well. The data will need to be manipulated slightly for the facet visualization. The <code>gather()</code> function from the <code>tidyr</code> package is used to reshape the data into a long format data frame with column names “key” and “value” indicating all columns except for index are to be reshaped. The “key” column is then mutated using <code>mutate()</code> to a factor which preserves the order of the keys so “observed” comes first when plotting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">decomp_fit_ets <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> key, <span class="dt">value =</span> value, <span class="op">-</span>index) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">key =</span> forcats<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/forcats/topics/as_factor">as_factor</a></span>(key)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> index, <span class="dt">y =</span> value, <span class="dt">group =</span> key)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">2</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/geom_ma">geom_ma</a></span>(<span class="dt">ma_fun =</span> SMA, <span class="dt">n =</span> <span class="dv">12</span>, <span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>key, <span class="dt">scales =</span> <span class="st">"free_y"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_yearmon</span>(<span class="dt">n =</span> <span class="dv">10</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"US Alcohol Sales: ETS Decomposition"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">45</span>, <span class="dt">hjust =</span> <span class="dv">1</span>))</code></pre></div>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_path).</code></pre>
<p><img src="SW00_Introduction_to_sweep_files/figure-html/unnamed-chunk-14-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Under normal circumstances it would make sense to refine the model at this point. However, in the interest of showing capabilities (rather than how to forecast) we move onto forecasting the model. For more information on how to forecast, please refer to the online book <a href="https://www.otexts.org/book/fpp"><em>“Forecasting: principles and practices”</em></a>.</p>
</div>
</div>
<div id="step-3-forecasting-the-model" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3-forecasting-the-model" class="anchor"></a>Step 3: Forecasting the model</h2>
<p>Next we forecast the ETS model using the <code><a href="http://www.rdocumentation.org/packages/forecast/topics/forecast">forecast()</a></code> function. The returned <code>forecast</code> object isn’t in a “tidy” format (i.e. data frame). This is where the <code><a href="../reference/sw_sweep.html">sw_sweep()</a></code> function helps.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fcast_ets &lt;-<span class="st"> </span>fit_ets <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/forecast/topics/forecast">forecast</a></span>(<span class="dt">h =</span> <span class="dv">12</span>) </code></pre></div>
</div>
<div id="step-4-tidy-the-forecast-object" class="section level2">
<h2 class="hasAnchor">
<a href="#step-4-tidy-the-forecast-object" class="anchor"></a>Step 4: Tidy the forecast object</h2>
<p>We’ll use the <code><a href="../reference/sw_sweep.html">sw_sweep()</a></code> function to coerce a <code>forecast</code> into a “tidy” data frame. The <code><a href="../reference/sw_sweep.html">sw_sweep()</a></code> function then coerces the <code>forecast</code> object into a tibble that can be sent to <code>ggplot</code> for visualization. Let’s inspect the result.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_sweep.html">sw_sweep</a></span>(fcast_ets, <span class="dt">fitted =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## # A tibble: 252 x 7
##            index    key price lo.80 lo.95 hi.80 hi.95
##    &lt;S3: yearmon&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1      Jan 2007 actual  6627    NA    NA    NA    NA
##  2      Feb 2007 actual  6743    NA    NA    NA    NA
##  3      Mar 2007 actual  8195    NA    NA    NA    NA
##  4      Apr 2007 actual  7828    NA    NA    NA    NA
##  5      May 2007 actual  9570    NA    NA    NA    NA
##  6      Jun 2007 actual  9484    NA    NA    NA    NA
##  7      Jul 2007 actual  8608    NA    NA    NA    NA
##  8      Aug 2007 actual  9543    NA    NA    NA    NA
##  9      Sep 2007 actual  8123    NA    NA    NA    NA
## 10      Oct 2007 actual  9649    NA    NA    NA    NA
## # ... with 242 more rows</code></pre>
<p>The tibble returned contains “index”, “key” and “value” (or in this case “price”) columns in a long or “tidy” format that is ideal for visualization with <code>ggplot2</code>. The “index” is in a regularized format (in this case <code>yearmon</code>) because the <code>forecast</code> package uses <code>ts</code> objects. We’ll see how we can get back to the original irregularized format (in this case <code>date</code>) later. The “key” and “price” columns contains three groups of key-value pairs:</p>
<ol style="list-style-type: decimal">
<li>
<strong>actual</strong>: the actual values from the original data</li>
<li>
<strong>fitted</strong>: the model values returned from the <code><a href="http://www.rdocumentation.org/packages/forecast/topics/ets">ets()</a></code> function (excluded by default)</li>
<li>
<strong>forecast</strong>: the predicted values from the <code><a href="http://www.rdocumentation.org/packages/forecast/topics/forecast">forecast()</a></code> function</li>
</ol>
<p>The <code><a href="../reference/sw_sweep.html">sw_sweep()</a></code> function contains an argument <code>fitted = FALSE</code> by default meaning that the model “fitted” values are not returned. We can toggle this on if desired. The remaining columns are the forecast confidence intervals (typically 80 and 95, but this can be changed with <code><a href="http://www.rdocumentation.org/packages/forecast/topics/forecast">forecast(level = c(80, 95))</a></code>). These columns are setup in a wide format to enable using the <code>geom_ribbon()</code>.</p>
<p>Let’s visualize the forecast with <code>ggplot2</code>. We’ll use a combination of <code>geom_line()</code> and <code>geom_ribbon()</code>. The fitted values are toggled off by default to reduce the complexity of the plot, but these can be added if desired. Note that because we are using a regular time index of the <code>yearmon</code> class, we need to add <code>scale_x_yearmon()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_sweep.html">sw_sweep</a></span>(fcast_ets) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> index, <span class="dt">y =</span> price, <span class="dt">color =</span> key)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">95</span>, <span class="dt">ymax =</span> hi.<span class="dv">95</span>), 
                <span class="dt">fill =</span> <span class="st">"#D5DBFF"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">80</span>, <span class="dt">ymax =</span> hi.<span class="dv">80</span>, <span class="dt">fill =</span> key), 
                <span class="dt">fill =</span> <span class="st">"#596DD5"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"US Alcohol Sales, ETS Model Forecast"</span>, <span class="dt">x =</span> <span class="st">""</span>, <span class="dt">y =</span> <span class="st">"Millions"</span>,
         <span class="dt">subtitle =</span> <span class="st">"Regular Time Index"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_yearmon</span>(<span class="dt">n =</span> <span class="dv">12</span>, <span class="dt">format =</span> <span class="st">"%Y"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/scale_manual">scale_color_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/scale_manual">scale_fill_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() </code></pre></div>
<p><img src="SW00_Introduction_to_sweep_files/figure-html/unnamed-chunk-17-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Because the <code>ts</code> object was created with the <code><a href="http://www.rdocumentation.org/packages/timetk/topics/tk_ts">tk_ts()</a></code> function, it contained a timetk index that was carried with it throughout the forecasting workflow. As a result, we can use the <code>timetk_idx</code> argument, which maps the original irregular index (dates) and a generated future index to the regularized time series (yearmon). This results in the ability to return an index of date and datetime, which is not currently possible with the <code>forecast</code> objects. Notice that the index is returned as <code>date</code> class.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_sweep.html">sw_sweep</a></span>(fcast_ets, <span class="dt">timetk_idx =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">head</span>()</code></pre></div>
<pre><code>## # A tibble: 6 x 7
##        index    key price lo.80 lo.95 hi.80 hi.95
##       &lt;date&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1 2006-12-31 actual  6627    NA    NA    NA    NA
## 2 2007-01-31 actual  6743    NA    NA    NA    NA
## 3 2007-02-28 actual  8195    NA    NA    NA    NA
## 4 2007-03-31 actual  7828    NA    NA    NA    NA
## 5 2007-04-30 actual  9570    NA    NA    NA    NA
## 6 2007-05-31 actual  9484    NA    NA    NA    NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_sweep.html">sw_sweep</a></span>(fcast_ets, <span class="dt">timetk_idx =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tail</span>()</code></pre></div>
<pre><code>## # A tibble: 6 x 7
##        index      key    price    lo.80    lo.95    hi.80    hi.95
##       &lt;date&gt;    &lt;chr&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 2017-06-01 forecast 11996.58 11324.49 10968.70 12668.67 13024.46
## 2 2017-07-01 forecast 12473.36 11770.36 11398.21 13176.36 13548.51
## 3 2017-08-01 forecast 11931.31 11254.75 10896.60 12607.87 12966.03
## 4 2017-09-01 forecast 12524.41 11809.80 11431.51 13239.02 13617.32
## 5 2017-10-01 forecast 12320.94 11613.49 11238.99 13028.39 13402.89
## 6 2017-11-01 forecast 14372.94 13542.37 13102.69 15203.51 15643.19</code></pre>
<p>We can build the same plot with dates in the x-axis now.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/sw_sweep.html">sw_sweep</a></span>(fcast_ets, <span class="dt">timetk_idx =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> index, <span class="dt">y =</span> price, <span class="dt">color =</span> key)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">95</span>, <span class="dt">ymax =</span> hi.<span class="dv">95</span>), 
                <span class="dt">fill =</span> <span class="st">"#D5DBFF"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">80</span>, <span class="dt">ymax =</span> hi.<span class="dv">80</span>, <span class="dt">fill =</span> key), 
                <span class="dt">fill =</span> <span class="st">"#596DD5"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">size =</span> <span class="dv">1</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"US Alcohol Sales, ETS Model Forecast"</span>, <span class="dt">x =</span> <span class="st">""</span>, <span class="dt">y =</span> <span class="st">"Millions"</span>, 
         <span class="dt">subtitle =</span> <span class="st">"Irregular Time Index"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_x_date</span>(<span class="dt">date_breaks =</span> <span class="st">"1 year"</span>, <span class="dt">date_labels =</span> <span class="st">"%Y"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/scale_manual">scale_color_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/scale_manual">scale_fill_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() </code></pre></div>
<p><img src="SW00_Introduction_to_sweep_files/figure-html/unnamed-chunk-20-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>In this example, there is not much benefit to returning an irregular time series. However, when working with frequencies below monthly, the ability to return irregular index values becomes more apparent.</p>
</div>
</div>
<div id="recap" class="section level1">
<h1 class="hasAnchor">
<a href="#recap" class="anchor"></a>Recap</h1>
<p>This was an overview of how various functions within the <code>sweep</code> package can be used to assist in forecast analysis. In the next vignette, we discuss some more powerful concepts including forecasting at scale with grouped time series analysis.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#forecasting-sales-of-beer-wine-and-distilled-alcohol-beverages">Forecasting Sales of Beer, Wine, and Distilled Alcohol Beverages</a></li>
      <li>
<a href="#forecasting-workflow">Forecasting Workflow</a><ul class="nav nav-pills nav-stacked">
<li><a href="#step-1-coerce-to-a-ts-object-class">Step 1: Coerce to a <code>ts</code> object class</a></li>
      <li><a href="#step-2-modeling-a-time-series">Step 2: Modeling a time series</a></li>
      <li><a href="#step-3-forecasting-the-model">Step 3: Forecasting the model</a></li>
      <li><a href="#step-4-tidy-the-forecast-object">Step 4: Tidy the forecast object</a></li>
      </ul>
</li>
      <li><a href="#recap">Recap</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matt Dancho, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
